<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Private Chat - The Monday Meet</title>
    <meta name="description" content="Real-time private chat - secure messaging with no registration required">
    <meta name="keywords" content="private chat, real-time messaging, secure chat">
    <meta property="og:title" content="Private Chat - The Monday Meet">
    <meta property="og:description" content="Secure, real-time messaging with no registration required.">
    <meta property="og:type" content="website">
    
    <!-- Existing CSS Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel for JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Handlee&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .handlee {
            font-family: 'Handlee', cursive;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            html {
                font-size: 16px; /* Prevent iOS zoom on input focus */
                -webkit-text-size-adjust: 100%;
            }
            
            body {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: none;
                touch-action: pan-y;
            }

            /* Hide debug overlays and cursor on mobile */
            .debug-overlay,
            .debug-panel,
            .debug-checklist,
            .dev-overlay {
                display: none !important;
                visibility: hidden !important;
            }

            /* Remove text cursor on mobile inputs when not focused */
            input[type="text"]:not(:focus),
            textarea:not(:focus) {
                caret-color: transparent;
            }

            /* Hide blinking cursor completely on mobile */
            input[type="text"],
            textarea {
                caret-color: #8b5cf6;
            }

            input[type="text"]:focus,
            textarea:focus {
                caret-color: #8b5cf6;
            }
            
            .safe-area-bottom {
                padding-bottom: env(safe-area-inset-bottom, 1rem);
            }
            
            /* Fix viewport height on mobile */
            .mobile-vh {
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            /* Ensure input doesn't get cut off */
            input[type="text"] {
                font-size: 16px !important; /* Prevent iOS zoom */
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* Fix mobile scrolling issues */
            .mobile-scroll-fix {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                scroll-behavior: smooth;
                transform: translateZ(0); /* Force hardware acceleration */
                will-change: scroll-position;
            }
            
            /* Prevent tilt/transform issues on scroll */
            .no-transform-on-scroll {
                transform: none !important;
                transition: none !important;
            }
            
            /* Remove hover effects on touch devices */
            .mobile-no-hover:hover {
                transform: none !important;
                box-shadow: none !important;
            }
            
            /* Fix backdrop blur performance on mobile */
            .backdrop-blur-lg {
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
            }
            
            /* Prevent rubber band scrolling */
            html {
                overflow: hidden;
                height: 100%;
                width: 100%;
            }
            
            body {
                overscroll-behavior: none;
                height: 100%;
                width: 100%;
            }
            
            /* Allow scrolling only in chat container */
            .chat-container {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                overflow: hidden;
            }
            
            /* Smooth momentum scrolling */
            .message-scroll {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior-y: contain;
                scroll-snap-type: none;
            }
            
            /* Prevent horizontal overflow */
            * {
                box-sizing: border-box;
            }
            
            .chat-container,
            .chat-container * {
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            /* Ensure buttons don't cause overflow */
            .mobile-header-buttons {
                display: flex;
                gap: 0.25rem;
                flex-shrink: 0;
                align-items: center;
            }
            
            /* Force text truncation where needed */
            .mobile-truncate {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                min-width: 0;
            }

            /* Hide any debug elements that might appear */
            *[id*="debug"],
            *[class*="debug"],
            *[class*="dev-"],
            *[class*="test-"],
            .checklist,
            .status-list,
            .error-list {
                display: none !important;
                opacity: 0 !important;
                visibility: hidden !important;
                position: absolute !important;
                left: -9999px !important;
            }

            /* Ensure title is always visible on mobile */
            h1, .title, [class*="title"] {
                visibility: visible !important;
                opacity: 1 !important;
                display: block !important;
            }

            /* Remove text selection cursor artifacts */
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            /* Allow text selection only in input fields and messages */
            input, textarea, .message-text, [class*="message"] p {
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }

            /* Enhanced mobile header visibility */
            h1, .font-semibold {
                color: #1a1a1a !important;
                font-weight: 700 !important;
                opacity: 1 !important;
            }

            /* Better contrast for mobile text */
            .text-gray-800 {
                color: #1a1a1a !important;
            }

            .text-gray-600 {
                color: #4a4a4a !important;
            }

            .text-gray-500 {
                color: #6b7280 !important;
            }

            /* Ensure header background is solid on mobile */
            .bg-white\/80 {
                background-color: rgba(255, 255, 255, 0.95) !important;
            }

            /* Better button visibility on mobile */
            button {
                font-weight: 600 !important;
            }

            /* Ensure all text is readable */
            * {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            /* Make empty state text more visible */
            .text-center p {
                color: #1a1a1a !important;
                font-weight: 600 !important;
            }

            .text-center p.text-gray-500 {
                color: #6b7280 !important;
                font-weight: 500 !important;
            }

            /* Ensure message text is visible */
            .text-gray-800 {
                color: #111827 !important;
            }

            /* Better visibility for all text elements */
            p, span, div {
                color: inherit;
                opacity: 1 !important;
            }

            /* Force visible text in messages */
            .break-words {
                color: inherit !important;
                opacity: 1 !important;
            }

            /* Improve input visibility */
            input::placeholder {
                color: #9ca3af !important;
                opacity: 1 !important;
            }

            input {
                color: #1a1a1a !important;
            }

            /* Make input bar highly visible on mobile */
            input[type="text"] {
                background-color: #ffffff !important;
                border: 2px solid #a855f7 !important;
                color: #1a1a1a !important;
                font-size: 16px !important;
                font-weight: 500 !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            }

            input[type="text"]:focus {
                background-color: #ffffff !important;
                border-color: #9333ea !important;
                box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2) !important;
            }

            /* Make input container more visible */
            .bg-white\/80.backdrop-blur-lg.border-t {
                background-color: rgba(255, 255, 255, 0.98) !important;
                border-top: 2px solid rgba(168, 85, 247, 0.2) !important;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05) !important;
            }

            /* Ensure emoji and send buttons are visible */
            .bg-yellow-100 {
                background-color: #fef3c7 !important;
                border: 2px solid #fbbf24 !important;
            }

            .bg-gradient-to-r {
                box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3) !important;
            }

            /* Add padding to input area for better visibility */
            .safe-area-bottom {
                padding: 1rem !important;
                background: linear-gradient(to top, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0.98)) !important;
            }

            /* Make sure input is always visible */
            input[type="text"]::placeholder {
                color: #9ca3af !important;
                font-weight: 400 !important;
            }

            /* Increase input height for better touch targets */
            input[type="text"] {
                min-height: 44px !important;
                padding: 12px 16px !important;
            }

            /* Better button visibility */
            button.flex-shrink-0 {
                min-width: 44px !important;
                min-height: 44px !important;
            }
        }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .animate-bounce {
            animation: bounce 1.4s infinite ease-in-out;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="chat-app"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Enhanced icon components
        const Send = ({ size = 20, className = "" }) => React.createElement('svg', { 
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none', 
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('line', { x1: 22, y1: 2, x2: 11, y2: 13 }), React.createElement('polygon', { points: '22,2 15,22 11,13 2,9' }));
        
        const Lock = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('rect', { x: 3, y: 11, width: 18, height: 11, rx: 2, ry: 2 }), React.createElement('circle', { cx: 12, cy: 16, r: 1 }), React.createElement('path', { d: 'm7,11V7a5,5,0,0,1,10,0v4' }));
        
        const Shield = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('path', { d: 'M12,22s8-4,8-10V5l-8-3L4,5v7c0,6,8,10,8,10z' }));
        
        const Heart = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('path', { d: 'm20.84,4.61a5.5,5.5,0,0,0-7.78,0L12,5.67l-1.06-1.06a5.5,5.5,0,0,0-7.78,7.78l1.06,1.06L12,21.23l7.78-7.78,1.06-1.06a5.5,5.5,0,0,0,0-7.78z' }));
        
        const Check = ({ size = 14, className = "" }) => React.createElement('svg', { 
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none', 
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('polyline', { points: '20,6 9,17 4,12' }));
        
        const CheckCheck = ({ size = 14, className = "" }) => React.createElement('svg', { 
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none', 
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('polyline', { points: '9,11 12,14 22,4' }), React.createElement('path', { d: 'm21,12v7a2,2,0,0,1-2,2H5a2,2,0,0,1-2-2V5a2,2,0,0,1,2-2h11' }));
        
        const Loader = ({ size = 32, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('line', { x1: 12, y1: 2, x2: 12, y2: 6 }), React.createElement('line', { x1: 12, y1: 18, x2: 12, y2: 22 }), React.createElement('line', { x1: 4.93, y1: 4.93, x2: 7.76, y2: 7.76 }), React.createElement('line', { x1: 16.24, y1: 16.24, x2: 19.07, y2: 19.07 }), React.createElement('line', { x1: 2, y1: 12, x2: 6, y2: 12 }), React.createElement('line', { x1: 18, y1: 12, x2: 22, y2: 12 }), React.createElement('line', { x1: 4.93, y1: 19.07, x2: 7.76, y2: 16.24 }), React.createElement('line', { x1: 16.24, y1: 7.76, x2: 19.07, y2: 4.93 }));

        const MessageCircle = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('path', { d: 'M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z' }));

        const Users = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('path', { d: 'M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2' }), React.createElement('circle', { cx: 9, cy: 7, r: 4 }), React.createElement('path', { d: 'm22 21v-2a4 4 0 0 0-3-3.87' }), React.createElement('path', { d: 'm16 3.13a4 4 0 0 1 0 7.75' }));

        const Zap = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('polygon', { points: '13,2 3,14 12,14 11,22 21,10 12,10 13,2' }));

        const Sparkles = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('path', { d: 'm9 11 3-3 3 3' }), React.createElement('path', { d: 'm22 12-3-3-3 3' }), React.createElement('path', { d: 'm2 12 3 3 3-3' }), React.createElement('path', { d: 'm13 21-3-3-3 3' }), React.createElement('circle', { cx: 12, cy: 12, r: 2 }));

        const Trash = ({ size = 16, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('polyline', { points: '3,6 5,6 21,6' }), React.createElement('path', { d: 'm19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2v2' }));

        const Smile = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('circle', { cx: 12, cy: 12, r: 10 }), React.createElement('path', { d: 'm8 14s1.5 2 4 2 4-2 4-2' }), React.createElement('line', { x1: 9, y1: 9, x2: 9.01, y2: 9 }), React.createElement('line', { x1: 15, y1: 9, x2: 15.01, y2: 9 }));

        const Bell = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('path', { d: 'M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9' }), React.createElement('path', { d: 'm13.73 21a2 2 0 0 1-3.46 0' }));

        // Firebase configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAxL7T8IAR3WFjsmoCyn_lOVfjkxJX2Yto",
            authDomain: "lovelatter-chat.firebaseapp.com",
            databaseURL: "https://lovelatter-chat-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "lovelatter-chat",
            storageBucket: "lovelatter-chat.firebasestorage.app",
            messagingSenderId: "633229169343",
            appId: "1:633229169343:web:4a8daec614adbaba0cac0a"
        };

        // Initialize Firebase
        let firebaseApp = null;
        let database = null;

        const initFirebase = () => {
            if (!firebaseApp) {
                try {
                    firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
                    database = firebase.database();
                    return Promise.resolve(database);
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    return Promise.reject(error);
                }
            }
            return Promise.resolve(database);
        };

        const ChatApp = () => {
            const [chatId] = useState('love-chat-main'); // Fixed chat room for everyone
            const [userId] = useState(() => {
                // Create or get persistent user ID
                let storedUserId = localStorage.getItem('chat-user-id');
                if (!storedUserId) {
                    storedUserId = 'user_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('chat-user-id', storedUserId);
                }
                return storedUserId;
            });
            const [message, setMessage] = useState('');
            const [messages, setMessages] = useState([]);
            const [isInChat, setIsInChat] = useState(false);
            const [isTyping, setIsTyping] = useState(false);
            const [showWelcome, setShowWelcome] = useState(true);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            const [showEmojiPicker, setShowEmojiPicker] = useState(false);
            const [notifications, setNotifications] = useState([]);
            const messagesEndRef = useRef(null);
            const typingTimeoutRef = useRef(null);
            const lastTypingUpdateRef = useRef(0);

            // Auto-scroll to bottom
            const scrollToBottom = () => {
                try {
                    if (messagesEndRef.current && typeof messagesEndRef.current.scrollIntoView === 'function') {
                        messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) {
                    console.debug('Scroll error (safe to ignore):', err);
                }
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // Initialize Firebase and start chat automatically
            useEffect(() => {
                const init = async () => {
                    try {
                        // Wait for DOM to be ready before initializing
                        if (document.readyState === 'loading') {
                            await new Promise(resolve => {
                                document.addEventListener('DOMContentLoaded', resolve, { once: true });
                            });
                        }

                        await initFirebase();
                        
                        // Auto-start chat after 2 seconds of welcome screen
                        setTimeout(() => {
                            if (document.hasFocus !== false) { // Check if page is still active
                                setIsInChat(true);
                                setShowWelcome(false);
                            }
                        }, 2000);
                        
                        setIsLoading(false);
                    } catch (err) {
                        console.error('Firebase initialization error:', err);
                        setError('Failed to initialize Firebase. Please check your configuration.');
                        setIsLoading(false);
                    }
                };
                
                init();
            }, []);

            // Listen to messages and typing when in chat
            useEffect(() => {
                if (!isInChat || !chatId || !database) return;

                const messagesRef = database.ref(`chats/${chatId}/messages`);
                const typingRef = database.ref(`chats/${chatId}/typing`);

                const onMessageAdded = messagesRef.on('child_added', (snapshot) => {
                    const msg = snapshot.val();
                    if (msg) {
                        setMessages(prev => {
                            // Avoid duplicates
                            if (prev.some(m => m.id === snapshot.key)) return prev;
                            
                            // Show notification for messages from others
                            if (msg.sender !== userId) {
                                addNotification(`New message: ${msg.text.slice(0, 30)}${msg.text.length > 30 ? '...' : ''}`, 'info');
                            }
                            
                            return [...prev, { id: snapshot.key, ...msg }];
                        });
                    }
                });

                const onMessageChanged = messagesRef.on('child_changed', (snapshot) => {
                    const updatedMsg = snapshot.val();
                    setMessages(prev => prev.map(m => 
                        m.id === snapshot.key ? { id: snapshot.key, ...updatedMsg } : m
                    ));
                });

                const onTypingChanged = typingRef.on('value', (snapshot) => {
                    const typingData = snapshot.val() || {};
                    const othersTyping = Object.entries(typingData).some(
                        ([id, isTyping]) => id !== userId && isTyping
                    );
                    setIsTyping(othersTyping);
                });

                // Update last activity
                database.ref(`chats/${chatId}/lastActivity`).set(Date.now());

                return () => {
                    messagesRef.off('child_added', onMessageAdded);
                    messagesRef.off('child_changed', onMessageChanged);
                    typingRef.off('value', onTypingChanged);
                };
            }, [isInChat, chatId, userId]);

            // Mark messages as read
            useEffect(() => {
                if (!isInChat) return;
                
                messages.forEach(msg => {
                    if (msg.sender !== userId && !msg.read) {
                        markAsRead(msg.id);
                    }
                });
            }, [messages, isInChat, userId]);

            const updateTypingStatus = (typing) => {
                try {
                    if (!database || !chatId || !userId) return;
                    const now = Date.now();
                    if (now - lastTypingUpdateRef.current < 1000) return;
                    lastTypingUpdateRef.current = now;
                    database.ref(`chats/${chatId}/typing/${userId}`).set(typing).catch(err => {
                        console.debug('Typing status update error (safe to ignore):', err);
                    });
                } catch (err) {
                    console.debug('Typing status error (safe to ignore):', err);
                }
            };

            const handleMessageChange = (e) => {
                setMessage(e.target.value);
                updateTypingStatus(true);
                
                clearTimeout(typingTimeoutRef.current);
                typingTimeoutRef.current = setTimeout(() => {
                    updateTypingStatus(false);
                }, 2000);
            };

            const sendMessage = async () => {
                if (!message.trim()) return;

                // Always clear the message immediately for better UX
                const messageToSend = message.trim();
                console.log('Sending message:', messageToSend);
                setMessage('');
                updateTypingStatus(false);

                // If Firebase isn't ready, show error but keep message cleared
                if (!database) {
                    console.warn('Firebase not initialized, message not sent:', messageToSend);
                    setError('Chat not connected. Please refresh the page.');
                    return;
                }

                try {
                    const newMessage = {
                        text: messageToSend,
                        sender: userId,
                        timestamp: Date.now(),
                        read: false
                    };

                    await database.ref(`chats/${chatId}/messages`).push(newMessage);
                } catch (err) {
                    console.error("Error sending message:", err);
                    setError('Failed to send message. Please try again.');
                    // Auto-clear error after 5 seconds
                    setTimeout(() => setError(''), 5000);
                }
            };

            const markAsRead = async (msgId) => {
                if (!database) return;
                try {
                    await database.ref(`chats/${chatId}/messages/${msgId}`).update({ read: true });
                } catch (err) {
                    console.error("Error marking message as read:", err);
                }
            };

            const addReaction = async (msgId, emoji) => {
                if (!database) return;
                try {
                    const msgRef = database.ref(`chats/${chatId}/messages/${msgId}`);
                    const snapshot = await msgRef.once('value');
                    const msg = snapshot.val();
                    
                    const reactions = msg.reactions || {};
                    reactions[userId] = emoji;
                    
                    await msgRef.update({ reactions });
                } catch (err) {
                    console.error("Error adding reaction:", err);
                }
            };

            const goHome = () => {
                window.location.href = '/';
            };

            // Telegram-style emoji collection
            const emojiCategories = {
                'Smileys': ['😀', '😁', '😂', '🤣', '😃', '😄', '😅', '😆', '😉', '😊', '😋', '😎', '😍', '😘', '🥰', '😗', '😙', '😚', '🙂', '🤗', '🤩', '🤔', '🤨', '😐', '😑', '😶', '🙄', '😏', '😣', '😥', '😮', '🤐', '😯', '😪', '😫', '🥱', '😴', '😌', '😛', '😜', '😝', '🤤', '😒', '😓', '😔', '😕', '🙃', '🤑', '😲', '😷', '🤒', '🤕'],
                'Hearts': ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '♥️', '💌', '💋', '😍', '🥰', '😘', '💑', '💏'],
                'Gestures': ['👍', '👎', '👌', '🤌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👋', '🤚', '🖐️', '✋', '🖖', '👏', '🙌', '🤝', '🙏', '✍️', '💪', '🦾'],
                'Activities': ['⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🪀', '🏓', '🏸', '🏒', '🏑', '🥍', '🏏', '🪃', '🥅', '⛳', '🪁', '🏹', '🎣', '🤿', '🥊', '🥋', '🎽', '🛹', '🛼', '🛷', '⛸️', '🥌', '🎿', '⛷️', '🏂', '🪂', '🏋️‍♀️', '🏋️', '🏋️‍♂️'],
                'Animals': ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐻‍❄️', '🐨', '🐯', '🦁', '🐮', '🐷', '🐽', '🐸', '🐵', '🙈', '🙉', '🙊', '🐒', '🐔', '🐧', '🐦', '🐤', '🐣', '🐥', '🦆', '🦅', '🦉', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🪱', '🐛', '🦋', '🐌', '🐞', '🐜', '🪰', '🪲', '🪳', '🦟', '🦗'],
                'Food': ['🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶️', '🫑', '🌽', '🥕', '🫒', '🧄', '🧅', '🥔', '🍠', '🥐', '🥖', '🍞', '🥨', '🥯', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🌭', '🍔', '🍟', '🍕']
            };

            // Message deletion function
            const deleteMessage = async (msgId) => {
                if (!database) return;
                try {
                    await database.ref(`chats/${chatId}/messages/${msgId}`).remove();
                    addNotification('Message deleted', 'success');
                } catch (err) {
                    console.error("Error deleting message:", err);
                    addNotification('Failed to delete message', 'error');
                }
            };

            // Clear all messages function
            const clearAllMessages = async () => {
                if (!database) return;
                try {
                    await database.ref(`chats/${chatId}/messages`).remove();
                    addNotification('All messages cleared', 'success');
                } catch (err) {
                    console.error("Error clearing messages:", err);
                    addNotification('Failed to clear messages', 'error');
                }
            };

            // Switch user identity (for testing)
            const switchUser = () => {
                localStorage.removeItem('chat-user-id');
                window.location.reload();
            };

            // Notification system
            const addNotification = (text, type = 'info') => {
                const notification = {
                    id: Date.now(),
                    text,
                    type,
                    timestamp: Date.now()
                };
                setNotifications(prev => [...prev, notification]);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    setNotifications(prev => prev.filter(n => n.id !== notification.id));
                }, 3000);
            };

            // Add emoji to message
            const addEmoji = (emoji) => {
                setMessage(prev => prev + emoji);
                setShowEmojiPicker(false);
            };

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-rose-50">
                        <Loader className="animate-spin text-purple-500" size={32} />
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-red-50 to-pink-100 p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
                            <div className="text-red-500 text-xl mb-4">Error</div>
                            <p className="text-gray-600 mb-6">{error}</p>
                            <button
                                onClick={() => window.location.reload()}
                                className="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            if (showWelcome && !isInChat) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-rose-50 flex items-center justify-center p-4">
                        <div className="max-w-md w-full">
                            <div className="bg-white/80 backdrop-blur-lg rounded-3xl shadow-2xl p-8 border border-white/20">
                                <div className="text-center mb-8">
                                    <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-3xl mb-6">
                                        <MessageCircle size={32} className="text-white" />
                                    </div>
                                    <h1 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2 handlee">
                                        Chat
                                    </h1>
                                    <p className="text-gray-600 flex items-center justify-center gap-2">
                                        <MessageCircle size={16} className="text-purple-400" />
                                        Simple, private messaging
                                        <MessageCircle size={16} className="text-pink-400" />
                                    </p>
                                </div>

                                <div className="space-y-6">
                                    <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6 space-y-4">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                                <Users size={20} className="text-purple-500" />
                                            </div>
                                            <div>
                                                <p className="font-semibold text-gray-800 text-sm">Shared Chat</p>
                                                <p className="text-gray-600 text-xs">Just visit the same URL</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center">
                                                <Zap size={20} className="text-pink-500" />
                                            </div>
                                            <div>
                                                <p className="font-semibold text-gray-800 text-sm">Real-time</p>
                                                <p className="text-gray-600 text-xs">Messages sync instantly</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-rose-100 rounded-full flex items-center justify-center">
                                                <Shield size={20} className="text-rose-500" />
                                            </div>
                                            <div>
                                                <p className="font-semibold text-gray-800 text-sm">Anonymous</p>
                                                <p className="text-gray-600 text-xs">No sign-up required</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="text-center">
                                        <div className="flex items-center justify-center gap-2 mb-4">
                                            <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                            <div className="w-2 h-2 bg-pink-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                            <div className="w-2 h-2 bg-rose-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                        </div>
                                        <p className="text-sm text-gray-600 mb-2">Loading...</p>
                                        <p className="text-xs text-gray-500">Send this link to chat together</p>
                                    </div>

                                    <div className="text-center">
                                        <button
                                            onClick={goHome}
                                            className="text-gray-500 text-sm hover:text-purple-500 transition-colors"
                                        >
                                            ← Back to Home
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Chat Room View
            if (isInChat) {
                const reactionEmojis = { heart: '❤️', smile: '😊', thumbsup: '👍' };
                
                return (
                    <div className="flex flex-col h-screen mobile-vh bg-gradient-to-br from-purple-50 via-pink-50 to-rose-50 no-transform-on-scroll chat-container">
                        {/* Header */}
                        <div className="bg-white/80 backdrop-blur-lg shadow-lg border-b border-white/20">
                            <div className="w-full px-3 sm:px-4 py-3 sm:py-4">
                                <div className="flex items-center justify-between min-w-0">
                                    <div className="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                                        <div className="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                                            <MessageCircle size={18} className="text-white sm:hidden" />
                                            <MessageCircle size={20} className="text-white hidden sm:block" />
                                        </div>
                                        <div className="min-w-0 flex-1">
                                            <h1 className="font-semibold text-gray-800 flex items-center gap-1 sm:gap-2 text-sm sm:text-base">
                                                Chat
                                                <MessageCircle size={14} className="text-purple-400 sm:hidden" />
                                                <MessageCircle size={16} className="text-purple-400 hidden sm:block" />
                                            </h1>
                                            <div className="flex items-center gap-1 sm:gap-2 text-xs text-gray-500">
                                                <div className={`w-2 h-2 rounded-full ${database ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                                <span className="truncate">{database ? 'Connected' : 'Connecting...'}</span>
                                                <Users size={10} className="text-gray-400 sm:hidden" />
                                                <Users size={12} className="text-gray-400 hidden sm:block" />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-1 sm:gap-2 flex-shrink-0 mobile-header-buttons">
                                        <button
                                            onClick={switchUser}
                                            className="px-2 py-1.5 sm:px-3 sm:py-2 text-blue-500 hover:bg-blue-50 rounded-lg transition flex items-center gap-1 sm:gap-2 mobile-no-hover active:bg-blue-100 text-xs sm:text-sm"
                                            title="Switch to other person (Testing)"
                                        >
                                            <Users size={14} className="sm:hidden" />
                                            <Users size={16} className="hidden sm:block" />
                                            <span className="hidden sm:inline">Switch</span>
                                        </button>
                                        <button
                                            onClick={clearAllMessages}
                                            className="px-2 py-1.5 sm:px-3 sm:py-2 text-red-500 hover:bg-red-50 rounded-lg transition flex items-center gap-1 sm:gap-2 mobile-no-hover active:bg-red-100 text-xs sm:text-sm"
                                            title="Clear all messages (Testing)"
                                        >
                                            <Trash size={14} className="sm:hidden" />
                                            <Trash size={16} className="hidden sm:block" />
                                            <span className="hidden sm:inline">Clear</span>
                                        </button>
                                        <button
                                            onClick={goHome}
                                            className="px-2 py-1.5 sm:px-4 sm:py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition mobile-no-hover active:bg-gray-200 text-xs sm:text-sm"
                                        >
                                            Home
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Notifications */}
                        <div className="fixed top-4 right-4 z-50 space-y-2">
                            {notifications.map(notification => (
                                <div
                                    key={notification.id}
                                    className={`px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in ${
                                        notification.type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                                        notification.type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                                        'bg-blue-100 text-blue-800 border border-blue-200'
                                    }`}
                                >
                                    <Bell size={16} />
                                    <span className="text-sm font-medium">{notification.text}</span>
                                </div>
                            ))}
                        </div>

                        {/* Error Banner */}
                        {error && (
                            <div className="bg-red-100 border border-red-300 text-red-700 px-4 py-2 text-sm">
                                <div className="flex items-center justify-between max-w-4xl mx-auto">
                                    <span>{error}</span>
                                    <button 
                                        onClick={() => setError('')}
                                        className="text-red-500 hover:text-red-700"
                                    >
                                        ×
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto overflow-x-hidden p-3 sm:p-4 mobile-scroll-fix message-scroll">
                            <div className="w-full space-y-3 sm:space-y-4">
                                {messages.length === 0 && (
                                    <div className="text-center py-12">
                                        <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-100 to-pink-100 rounded-full mb-4">
                                            <MessageCircle size={28} className="text-purple-500" />
                                        </div>
                                        <p className="text-gray-600 font-medium mb-2">Start a conversation</p>
                                        <p className="text-gray-500 text-sm">Type a message below</p>
                                    </div>
                                )}

                                {messages.map((msg) => {
                                    const isMe = msg.sender === userId;
                                    const reactions = msg.reactions || {};

                                    return (
                                        <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'} animate-fade-in`}>
                                            <div className={`max-w-[280px] sm:max-w-xs lg:max-w-md ${isMe ? 'items-end' : 'items-start'} flex flex-col gap-1 group`}>
                                                <div className={`px-4 py-3 rounded-2xl relative ${
                                                    isMe 
                                                        ? 'bg-gradient-to-br from-purple-500 to-pink-500 text-white rounded-br-md' 
                                                        : 'bg-white/80 backdrop-blur-lg text-gray-800 rounded-bl-md shadow-sm'
                                                }`}>
                                                    {/* Show sender name for others' messages */}
                                                    {!isMe && (
                                                        <p className="text-xs text-purple-600 font-medium mb-1">
                                                            {msg.sender.split('_')[1].substring(0, 6)}
                                                        </p>
                                                    )}
                                                    <p className="break-words">{msg.text}</p>
                                                    <div className="flex items-center justify-between gap-2 mt-1">
                                                        <div className="flex items-center gap-1">
                                                            <span className={`text-xs ${isMe ? 'text-purple-100' : 'text-gray-400'}`}>
                                                                {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                            </span>
                                                            {isMe && (
                                                                msg.read ? 
                                                                    <CheckCheck size={14} className="text-purple-100" /> : 
                                                                    <Check size={14} className="text-purple-100" />
                                                            )}
                                                        </div>
                                                        {/* Delete button - shows on hover */}
                                                        <button
                                                            onClick={() => deleteMessage(msg.id)}
                                                            className={`opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-red-500/20 ${
                                                                isMe ? 'text-purple-100 hover:text-red-200' : 'text-gray-400 hover:text-red-500'
                                                            }`}
                                                            title="Delete message"
                                                        >
                                                            <Trash size={12} />
                                                        </button>
                                                    </div>
                                                </div>

                                                {!isMe && (
                                                    <div className="flex gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        {['heart', 'smile', 'thumbsup'].map(emoji => (
                                                            <button
                                                                key={emoji}
                                                                onClick={() => addReaction(msg.id, emoji)}
                                                                className={`text-xs px-2 py-1 rounded-full transition-all ${
                                                                    reactions[userId] === emoji 
                                                                        ? 'bg-purple-100 text-purple-600' 
                                                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                                }`}
                                                            >
                                                                {reactionEmojis[emoji]}
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}

                                                {Object.keys(reactions).length > 0 && (
                                                    <div className="flex gap-1 text-sm ml-2">
                                                        {Object.values(reactions).map((emoji, i) => (
                                                            <span key={i}>{reactionEmojis[emoji]}</span>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}

                                {isTyping && (
                                    <div className="flex justify-start">
                                        <div className="bg-white/80 backdrop-blur-lg rounded-2xl rounded-bl-md px-4 py-3 shadow-sm">
                                            <div className="flex gap-1">
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div ref={messagesEndRef} />
                            </div>
                        </div>

                        {/* Emoji Picker */}
                        {showEmojiPicker && (
                            <div className="bg-white/95 backdrop-blur-lg border-t border-white/20 p-3 max-h-48 sm:max-h-64 overflow-y-auto overflow-x-hidden">
                                <div className="w-full">
                                    <div className="flex gap-2 mb-3 overflow-x-auto pb-2">
                                        {Object.keys(emojiCategories).map(category => (
                                            <button
                                                key={category}
                                                className="px-3 py-1 text-xs bg-purple-100 text-purple-600 rounded-full whitespace-nowrap hover:bg-purple-200 transition flex-shrink-0"
                                            >
                                                {category}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-6 sm:grid-cols-8 gap-1 sm:gap-2">
                                        {Object.values(emojiCategories).flat().slice(0, 48).map((emoji, index) => (
                                            <button
                                                key={index}
                                                onClick={() => addEmoji(emoji)}
                                                className="text-xl sm:text-2xl p-2 hover:bg-purple-50 rounded-lg transition aspect-square flex items-center justify-center"
                                            >
                                                {emoji}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Input */}
                        <div className="bg-white/80 backdrop-blur-lg border-t border-white/20 p-2 sm:p-3 pb-3 sm:pb-4 safe-area-bottom">
                            <div className="flex gap-2 w-full px-1">
                                <button
                                    onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                    className="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-yellow-100 text-yellow-600 rounded-2xl hover:bg-yellow-200 transition flex items-center justify-center mobile-no-hover active:bg-yellow-200 active:scale-95"
                                    title="Add emoji"
                                >
                                    <Smile size={16} className="sm:hidden" />
                                    <Smile size={18} className="hidden sm:block" />
                                </button>
                                <input
                                    type="text"
                                    value={message}
                                    onChange={handleMessageChange}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                            e.preventDefault();
                                            sendMessage();
                                        }
                                    }}
                                    placeholder="Type your message..."
                                    className="flex-1 min-w-0 px-3 py-2.5 sm:px-4 sm:py-3 bg-white/50 border border-purple-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-purple-300 focus:border-transparent transition-all text-base"
                                    ref={(input) => {
                                        if (input && message === '' && input.value !== '') {
                                            input.value = '';
                                        }
                                    }}
                                />
                                <button
                                    onClick={sendMessage}
                                    disabled={!message.trim()}
                                    className="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl hover:shadow-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center mobile-no-hover active:scale-95"
                                >
                                    <Send size={16} className="sm:hidden" />
                                    <Send size={18} className="hidden sm:block" />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        // Render the app with React 18 createRoot API
        const container = document.getElementById('chat-app');
        const root = ReactDOM.createRoot(container);
        root.render(<ChatApp />);
    </script>

    <!-- Privacy Tracker - Analytics -->
    <script src="assets/js/tracker.js"></script>
    <script>
        // Initialize Privacy Tracker for Chat Page - Using existing Firebase project
        const chatTracker = new PrivacyTracker({
            apiKey: "AIzaSyAxL7T8IAR3WFjsmoCyn_lOVfjkxJX2Yto",
            authDomain: "lovelatter-chat.firebaseapp.com",
            databaseURL: "https://lovelatter-chat-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "lovelatter-chat",
            storageBucket: "lovelatter-chat.firebasestorage.app",
            messagingSenderId: "633229169343",
            appId: "1:633229169343:web:4a8daec614adbaba0cac0a"
        });

        // Track chat-specific events with error handling
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Track when user sends first message
                let firstMessage = true;
                
                // Safely override sendMessage if it exists
                if (typeof sendMessage !== 'undefined') {
                    const originalSendMessage = sendMessage;
                    sendMessage = function() {
                        try {
                            if (firstMessage) {
                                chatTracker.track('first_message_sent');
                                firstMessage = false;
                            }
                            chatTracker.track('message_sent');
                            return originalSendMessage.apply(this, arguments);
                        } catch (err) {
                            console.debug('Tracking error (safe to ignore):', err);
                            return originalSendMessage.apply(this, arguments);
                        }
                    };
                }

                // Track emoji reactions with error handling
                document.addEventListener('click', (e) => {
                    try {
                        if (e.target && e.target.classList && e.target.classList.contains('reaction-btn')) {
                            chatTracker.track('emoji_reaction', { 
                                emoji: e.target.textContent ? e.target.textContent.trim() : ''
                            });
                        }
                    } catch (err) {
                        console.debug('Emoji tracking error (safe to ignore):', err);
                    }
                });
            } catch (err) {
                console.debug('Event tracking setup error (safe to ignore):', err);
            }
        });
    </script>
</body>
</html>
