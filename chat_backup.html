<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat - The Monday Meet</title>
    <meta name="description" content="Real-time private chat - secure messaging with no registration required">
    <meta name="keywords" content="private chat, real-time messaging, secure chat">
    <meta property="og:title" content="Private Chat - The Monday Meet">
    <meta property="og:description" content="Secure, real-time messaging with no registration required.">
    <meta property="og:type" content="website">
    
    <!-- Existing CSS Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel for JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Handlee&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .handlee {
            font-family: 'Handlee', cursive;
        }
    </style>
</head>
<body>
    <div id="chat-app"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Enhanced icon components with proper sizing
        const Send = ({ size = 20, className = "" }) => React.createElement('svg', { 
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none', 
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('line', { x1: 22, y1: 2, x2: 11, y2: 13 }), React.createElement('polygon', { points: '22,2 15,22 11,13 2,9' }));
        
        const Lock = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('rect', { x: 3, y: 11, width: 18, height: 11, rx: 2, ry: 2 }), React.createElement('circle', { cx: 12, cy: 16, r: 1 }), React.createElement('path', { d: 'm7,11V7a5,5,0,0,1,10,0v4' }));
        
        const Shield = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('path', { d: 'M12,22s8-4,8-10V5l-8-3L4,5v7c0,6,8,10,8,10z' }));
        
        const Heart = ({ size = 20, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('path', { d: 'm20.84,4.61a5.5,5.5,0,0,0-7.78,0L12,5.67l-1.06-1.06a5.5,5.5,0,0,0-7.78,7.78l1.06,1.06L12,21.23l7.78-7.78,1.06-1.06a5.5,5.5,0,0,0,0-7.78z' }));
        
        const Check = ({ size = 14, className = "" }) => React.createElement('svg', { 
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none', 
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('polyline', { points: '20,6 9,17 4,12' }));
        
        const CheckCheck = ({ size = 14, className = "" }) => React.createElement('svg', { 
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none', 
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('polyline', { points: '9,11 12,14 22,4' }), React.createElement('path', { d: 'm21,12v7a2,2,0,0,1-2,2H5a2,2,0,0,1-2-2V5a2,2,0,0,1,2-2h11' }));
        
        const Loader = ({ size = 32, className = "" }) => React.createElement('svg', {
            width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
            stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
            className
        }, React.createElement('line', { x1: 12, y1: 2, x2: 12, y2: 6 }), React.createElement('line', { x1: 12, y1: 18, x2: 12, y2: 22 }), React.createElement('line', { x1: 4.93, y1: 4.93, x2: 7.76, y2: 7.76 }), React.createElement('line', { x1: 16.24, y1: 16.24, x2: 19.07, y2: 19.07 }), React.createElement('line', { x1: 2, y1: 12, x2: 6, y2: 12 }), React.createElement('line', { x1: 18, y1: 12, x2: 22, y2: 12 }), React.createElement('line', { x1: 4.93, y1: 19.07, x2: 7.76, y2: 16.24 }), React.createElement('line', { x1: 16.24, y1: 7.76, x2: 19.07, y2: 4.93 }));

        // Firebase configuration - REPLACE WITH YOUR ACTUAL CONFIG
        const FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com", 
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let firebaseApp = null;
        let database = null;

        const initFirebase = () => {
            if (!firebaseApp) {
                try {
                    firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
                    database = firebase.database();
                    return Promise.resolve(database);
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    return Promise.reject(error);
                }
            }
            return Promise.resolve(database);
        };

        const ChatApp = () => {
            const [chatId, setChatId] = useState('');
            const [userId] = useState(() => 'user_' + Math.random().toString(36).substr(2, 9));
            const [message, setMessage] = useState('');
            const [messages, setMessages] = useState([]);
            const [isInChat, setIsInChat] = useState(false);
            const [isTyping, setIsTyping] = useState(false);
            const [showWelcome, setShowWelcome] = useState(true);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            const messagesEndRef = useRef(null);
            const typingTimeoutRef = useRef(null);
            const lastTypingUpdateRef = useRef(0);

            // Auto-scroll to bottom
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // Initialize Firebase and check URL for chat ID
            useEffect(() => {
                const init = async () => {
                    try {
                        await initFirebase();
                        
                        // Check URL for chat ID
                        const urlParams = new URLSearchParams(window.location.search);
                        const urlChatId = urlParams.get('chat');
                        
                        if (urlChatId) {
                            setChatId(urlChatId);
                            setIsInChat(true);
                            setShowWelcome(false);
                        }
                        
                        setIsLoading(false);
                    } catch (err) {
                        setError('Failed to initialize Firebase. Please check your configuration.');
                        setIsLoading(false);
                    }
                };
                
                init();
            }, []);

            // Listen to messages when in chat
            useEffect(() => {
                if (!isInChat || !chatId || !database) return;

                const messagesRef = database.ref(`chats/${chatId}/messages`);

                // Listen for new messages
                const onMessageAdded = messagesRef.on('child_added', (snapshot) => {
                    const msg = snapshot.val();
                    if (msg) {
                        setMessages(prev => {
                            // Avoid duplicates
                            if (prev.some(m => m.id === snapshot.key)) return prev;
                            return [...prev, { id: snapshot.key, ...msg }];
                        });
                    }
                });

                // Update last activity
                database.ref(`chats/${chatId}/lastActivity`).set(Date.now());

                return () => {
                    messagesRef.off('child_added', onMessageAdded);
                };
            }, [isInChat, chatId]);

            const generateChatId = () => {
                return Math.random().toString(36).substring(2, 10) + Date.now().toString(36);
            };

            const joinChat = () => {
                if (!username.trim() || !chatId.trim()) return;
                
                // Update URL without reload
                const newUrl = `${window.location.pathname}?chat=${chatId}`;
                window.history.pushState({}, '', newUrl);
                
                setIsInChat(true);
            };

            const sendMessage = async () => {
                if (!message.trim() || !database) return;

                try {
                    const newMessage = {
                        text: message.trim(),
                        sender: username,
                        timestamp: Date.now()
                    };

                    await database.ref(`chats/${chatId}/messages`).push(newMessage);
                    setMessage('');
                } catch (err) {
                    console.error("Error sending message:", err);
                    setError('Failed to send message. Please try again.');
                }
            };

            const copyChatLink = () => {
                const link = `${window.location.origin}${window.location.pathname}?chat=${chatId}`;
                navigator.clipboard.writeText(link).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }).catch(() => {
                    setError('Failed to copy link');
                });
            };

            const clearChat = async () => {
                if (!database || !window.confirm('Delete all messages? This cannot be undone.')) return;
                
                try {
                    await database.ref(`chats/${chatId}/messages`).remove();
                    setMessages([]);
                } catch (err) {
                    console.error("Error clearing chat:", err);
                    setError('Failed to clear chat');
                }
            };

            const leaveChat = () => {
                setIsInChat(false);
                setMessages([]);
                setChatId('');
                setUsername('');
                window.history.pushState({}, '', window.location.pathname);
            };

            const goHome = () => {
                window.location.href = '/';
            };

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                        <div className="text-gray-600 text-xl">Loading chat...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-red-50 to-pink-100 p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
                            <div className="text-red-500 text-xl mb-4">Error</div>
                            <p className="text-gray-600 mb-6">{error}</p>
                            <button
                                onClick={() => window.location.reload()}
                                className="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            // Chat Room View
            if (isInChat) {
                return (
                    <div className="flex flex-col h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                        {/* Header */}
                        <div className="bg-white shadow-md p-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={goHome}
                                    className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
                                    title="Go to home"
                                >
                                    <ArrowLeft />
                                </button>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">Private Chat</h1>
                                    <p className="text-sm text-gray-500">Room: {chatId}</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={copyChatLink}
                                    className="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                                >
                                    {copied ? <Check /> : <Copy />}
                                    {copied ? 'Copied!' : 'Share Link'}
                                </button>
                                <button
                                    onClick={clearChat}
                                    className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition"
                                    title="Clear chat"
                                >
                                    <Trash2 />
                                </button>
                                <button
                                    onClick={leaveChat}
                                    className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
                                >
                                    Leave
                                </button>
                            </div>
                        </div>

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {messages.length === 0 ? (
                                <div className="text-center text-gray-500 mt-10">
                                    <p>No messages yet. Start the conversation!</p>
                                </div>
                            ) : (
                                messages.map((msg) => {
                                    const isMe = msg.sender === username;
                                    return (
                                        <div
                                            key={msg.id}
                                            className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}
                                        >
                                            <div
                                                className={`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${
                                                    isMe
                                                        ? 'bg-blue-500 text-white'
                                                        : 'bg-white text-gray-800 shadow'
                                                }`}
                                            >
                                                <p className={`text-xs font-semibold mb-1 ${isMe ? 'text-blue-100' : 'text-gray-500'}`}>
                                                    {msg.sender}
                                                </p>
                                                <p className="break-words">{msg.text}</p>
                                                <p className={`text-xs mt-1 ${isMe ? 'text-blue-100' : 'text-gray-400'}`}>
                                                    {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                </p>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input */}
                        <div className="bg-white border-t p-4">
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={message}
                                    onChange={(e) => setMessage(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                    placeholder="Type a message..."
                                    className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <button
                                    onClick={sendMessage}
                                    className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-2"
                                >
                                    <Send />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Join/Create Chat View
            return (
                <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div className="flex items-center gap-3 mb-4">
                            <button
                                onClick={goHome}
                                className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
                                title="Go to home"
                            >
                                <ArrowLeft />
                            </button>
                            <h1 className="text-3xl font-bold text-gray-800 handlee">Private Chat</h1>
                        </div>
                        <p className="text-gray-600 mb-8">Secure, real-time messaging with no registration required</p>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Your Name
                                </label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    placeholder="Enter your name"
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Chat Room ID
                                </label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={chatId}
                                        onChange={(e) => setChatId(e.target.value)}
                                        placeholder="Enter or generate chat ID"
                                        className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button
                                        onClick={() => setChatId(generateChatId())}
                                        className="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
                                        title="Generate new ID"
                                    >
                                        Generate
                                    </button>
                                </div>
                            </div>

                            <button
                                onClick={joinChat}
                                disabled={!username.trim() || !chatId.trim()}
                                className="w-full px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-medium"
                            >
                                Join Chat Room
                            </button>
                        </div>

                        <div className="mt-8 p-4 bg-blue-50 rounded-lg">
                            <h3 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                <Clock />
                                How it works
                            </h3>
                            <ul className="text-sm text-gray-600 space-y-1">
                                <li>• Generate a unique chat ID and share it</li>
                                <li>• Both users enter the same chat ID</li>
                                <li>• Messages sync in real-time</li>
                                <li>• History persists across refreshes</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app with React 18 createRoot API
        const container = document.getElementById('chat-app');
        const root = ReactDOM.createRoot(container);
        root.render(<ChatApp />);
    </script>
</body>
</html>
